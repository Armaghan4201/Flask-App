<!-- app/templates/signup.html -->
{% extends "base.html" %}

{% block title %}Sign Up - Early Warning Text{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-7 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0 py-2"><i class="fas fa-user-plus me-2"></i>Create Your Account</h3>
                </div>
                <div class="card-body p-4">
                    <p class="lead mb-4">Join Early Warning Text to receive important alerts about natural disasters, power outages, and space weather events delivered directly to you.</p>
                    
                    <form method="POST" action="{{ url_for('main.signup') }}" class="needs-validation" novalidate>
                        <div class="mb-4">
                            <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-user"></i></span>
                                <input type="text" class="form-control" id="name" name="name" placeholder="Your full name" required aria-describedby="nameHelp">
                                <div class="invalid-feedback">
                                    Please provide your full name.
                                </div>
                            </div>
                            <div id="nameHelp" class="form-text">We'll use this to personalize your alerts</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-envelope"></i></span>
                                <input type="email" class="form-control" id="email" name="email" placeholder="your@email.com" required aria-describedby="emailHelp">
                                <div class="invalid-feedback">
                                    Please provide a valid email address.
                                </div>
                            </div>
                            <div id="emailHelp" class="form-text">We'll send alert notifications to this email address</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="phone_number" class="form-label">Phone Number</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-phone"></i></span>
                                <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                value="+" placeholder="+1 (555) 555-5555" aria-describedby="phoneHelp">
                            </div>
                            <div id="phoneHelp" class="form-text">Optional: We'll send SMS alerts to this number (include country code)</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-lock"></i></span>
                                <input type="password" class="form-control" id="password" name="password" placeholder="Create a secure password" required aria-describedby="passwordHelp">
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                </button>
                                <div class="invalid-feedback">
                                    Password must be at least 8 characters long.
                                </div>
                            </div>
                            <div id="passwordHelp" class="form-text">
                                Password must be at least 8 characters and contain:
                                <ul class="small mt-1 mb-0">
                                    <li>At least one uppercase letter</li>
                                    <li>At least one lowercase letter</li>
                                    <li>At least one number</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="confirm_password" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-lock"></i></span>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="Confirm your password" required>
                                <div class="invalid-feedback">
                                    Passwords do not match.
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h5 class="mb-3">Notification Preferences</h5>
                        
                        <div class="mb-3 form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="notify_email" name="notify_email" checked>
                            <label class="form-check-label" for="notify_email">Receive Email Notifications</label>
                        </div>
                        
                        <div class="mb-3 form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="notify_sms" name="notify_sms">
                            <label class="form-check-label" for="notify_sms">I want to receive SMS Notifications</label>
                            <div class="form-text small text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                If selected, you'll be asked to provide legal consent for text messaging on the next page as required by law.
                            </div>
                        </div>
                        
                        <div class="mb-4 form-check">
                            <input type="checkbox" class="form-check-input" id="terms" name="terms" required>
                            <label class="form-check-label" for="terms">
                                I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a> <span class="text-danger">*</span>
                            </label>
                            <div class="invalid-feedback">
                                You must agree to the terms and conditions.
                            </div>
                        </div>
                        
                        <div class="alert alert-light border p-3 mb-4">
                            <small class="text-muted">
                                By creating an account, you agree to receive automated notifications from Early Warning Text. Standard SMS rates may apply for text messages. You can update your preferences or delete your account at any time.
                            </small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </div>
                        
                        <div class="text-center mt-3">
                            <p class="mb-0">Already have an account? <a href="{{ url_for('main.login') }}">Sign in here</a></p>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4 shadow-sm">
                <div class="card-header bg-light">
                    <h4 class="card-title mb-0 py-2"><i class="fas fa-info-circle me-2"></i>What You'll Receive</h4>
                </div>
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="mb-3 text-primary">
                                    <i class="fas fa-globe-americas fa-3x"></i>
                                </div>
                                <h5>Natural Disasters</h5>
                                <p class="text-muted small">Earthquakes (7.0+), tsunamis, cyclones, floods</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="mb-3 text-primary">
                                    <i class="fas fa-plug fa-3x"></i>
                                </div>
                                <h5>Power Outages</h5>
                                <p class="text-muted small">Major outages affecting 20%+ of the US</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="mb-3 text-primary">
                                    <i class="fas fa-sun fa-3x"></i>
                                </div>
                                <h5>Space Weather</h5>
                                <p class="text-muted small">X-class solar flares and severe space events</p>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="alert alert-light border">
                        <p class="mb-0 text-muted"><i class="fas fa-shield-alt me-2"></i>We aim to provide timely, accurate alerts. However, we cannot guarantee immediate delivery or coverage of all events.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Password visibility toggle
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordField = document.getElementById('password');
        const toggleIcon = document.getElementById('togglePasswordIcon');
        
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        } else {
            passwordField.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    });

    // Password strength indicator
    document.getElementById('password').addEventListener('input', function() {
        const password = this.value;
        const helpText = document.getElementById('passwordHelp');
        
        const hasUpper = /[A-Z]/.test(password);
        const hasLower = /[a-z]/.test(password);
        const hasNumber = /\d/.test(password);
        const hasMinLength = password.length >= 8;
        
        let strength = 0;
        if (hasUpper) strength++;
        if (hasLower) strength++;
        if (hasNumber) strength++;
        if (hasMinLength) strength++;
        
        // Update help text color based on strength
        if (strength < 2) {
            helpText.className = 'form-text text-danger';
        } else if (strength < 4) {
            helpText.className = 'form-text text-warning';
        } else {
            helpText.className = 'form-text text-success';
        }
    });

    // Form validation
    (function () {
        'use strict'
        
        const forms = document.querySelectorAll('.needs-validation')
        
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                const password = form.querySelector('#password').value
                const confirmPassword = form.querySelector('#confirm_password').value
                const email = form.querySelector('#email').value
                const phone = form.querySelector('#phone_number').value
                const emailNotify = form.querySelector('#notify_email').checked
                const smsNotify = form.querySelector('#notify_sms').checked
                const terms = form.querySelector('#terms').checked
                
                let isValid = true
                
                // Password validation
                if (!validatePassword(password)) {
                    isValid = false
                    document.getElementById('password').classList.add('is-invalid')
                }
                
                // Confirm password validation
                if (password !== confirmPassword) {
                    isValid = false
                    document.getElementById('confirm_password').classList.add('is-invalid')
                }
                
                // Email validation
                if (!validateEmail(email)) {
                    isValid = false
                    document.getElementById('email').classList.add('is-invalid')
                }
                
                // Phone validation (if provided)
                if (phone && !validatePhone(phone)) {
                    isValid = false
                    alert('Please enter a valid phone number with country code.')
                }
                
                // Notification method validation
                if (!emailNotify && !smsNotify) {
                    isValid = false
                    alert('Please select at least one notification method.')
                }
                
                // SMS notification validation
                if (smsNotify && !phone) {
                    isValid = false
                    alert('Please provide a phone number to receive SMS notifications.')
                } else if (smsNotify) {
                    // Note: SMS consent will be handled on the next page
                    console.log('SMS consent will be requested on next page')
                }
                
                // Terms validation
                if (!terms) {
                    isValid = false
                    document.getElementById('terms').classList.add('is-invalid')
                }
                
                if (!isValid) {
                    event.preventDefault()
                    event.stopPropagation()
                } else {
                    form.classList.add('was-validated')
                }
            }, false)
        })
        
        function validatePassword(password) {
            const hasUpper = /[A-Z]/.test(password)
            const hasLower = /[a-z]/.test(password)
            const hasNumber = /\d/.test(password)
            const hasMinLength = password.length >= 8
            
            return hasUpper && hasLower && hasNumber && hasMinLength
        }
        
        function validateEmail(email) {
            const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/
            return re.test(email)
        }
        
        function validatePhone(phone) {
            // Remove all non-digit characters except plus sign
            const digitsOnly = phone.replace(/[^\d+]/g, '')
            // Check if it has a plus sign and is a valid length
            return digitsOnly.startsWith('+') && digitsOnly.length >= 8 && digitsOnly.length <= 15
        }
    })()
</script>
{% endblock %}